<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vert.x SockJS Client</title>
    <!-- Include SockJS and EventBus client libraries -->
    <script src="javascripts/sockjs.min.js"></script>
    <script src="javascripts/vertx-eventbus.js"></script>
</head>
<body>
    <h1>Vert.x SockJS Client</h1>
    <div id="messages"></div>
    <form id="messageForm">
        <input type="text" id="messageInput" placeholder="Type your message...">
        <button type="submit">Send</button>
    </form>
    <div id="status">Connecting...</div> <!-- Div for connection status -->

    <script>

        var eb = new EventBus('https://smartconsultor.com/eventbus');
        eb.enableReconnect(true);
        var writeHandlerID = null; // Variable to store the writeHandlerID
        // Handle connection status
        var statusDiv = document.getElementById('status');
        function updateStatus(connected) {
            statusDiv.textContent = connected ? 'Connected' : 'Disconnected';
        }

        // Handle incoming messages from the server
        eb.onopen = function () {
            console.log('Connected to Vert.x Event Bus');
            updateStatus(true);
                     
            eb.registerHandler('Free', function (error, message) {
                var messageDiv = document.createElement('div');
                messageDiv.textContent = message.body;
                document.getElementById('messages').appendChild(messageDiv);
            });
            
            // Direct WebSocket handler
            eb.socket.onmessage = function(event) {
                try {
                    var data = JSON.parse(event.data);
                    var messageDiv = document.createElement('div');
                    messageDiv.textContent = data.body;
                    document.getElementById('messages').appendChild(messageDiv);                    
                } catch (e) {
                    console.error('Failed to parse WebSocket message:', e);
                }
            };           
        };

        eb.onclose = function () {
            console.log('Disconnected from Vert.x Event Bus');
            updateStatus(false);
        };

        // Handle form submission to send messages to the server
        document.getElementById('messageForm').addEventListener('submit', function (event) {
            try {
                event.preventDefault();
                var messageInput = document.getElementById('messageInput');
                var messageText = messageInput.value.trim();
                if (messageText !== '') {
                    //eb.send(writeHandlerID, { body: messageText });
                    // Sử dụng `eb.socket.send` để gửi thông điệp trực tiếp qua WebSocket
                    var messageToSend = JSON.stringify({
                        type: 'send',
                        address: '',
                        body: { message: 'Hello from client using eb.socket!' }
                    });
                    // Gửi thông điệp qua WebSocket
                    eb.socket.send(messageToSend);
                    messageInput.value = '';
                }
            } catch (e) {
                console.error('Failed to parse WebSocket message:', e);
            }
        });
    </script>
</body>
</html>
